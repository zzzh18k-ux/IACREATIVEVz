<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gold Miner ELITE</title>
    
    <script src='//libtl.com/sdk.js' data-zone='10278425' data-sdk='show_10278425'></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght=700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* TEMA MINERO (Oro/Tierra) */
        :root { 
            --bg: #2c3e50; /* Fondo oscuro */
            --gold: #f1c40f; /* Amarillo Oro */
            --energy: #e74c3c; /* Rojo Energ√©tico */
            --green: #27ae60; /* Verde Dinero */
            --text: #ecf0f1; /* Texto Claro */
            --ground-top: #8B4513;
            --ground-bottom: #4A2509;
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg); color: var(--text); font-family: 'Nunito', sans-serif;
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; 
            padding: 20px; padding-bottom: 120px; 
            overflow-y: auto; margin: 0;
        }

        #banScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2f3542; z-index: 99999; 
            display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white;
        }

        .app-container { width: 100%; max-width: 400px; display: flex; flex-direction: column; align-items: center; gap: 10px; position: relative; }

        /* HEADER & SCORE (Adaptado al tema oscuro) */
        .score-board {
            background: #34495e; padding: 15px 25px; border-radius: 20px; border-bottom: 4px solid #2c3e50;
            display: flex; flex-direction: column; align-items: center; width: 100%; margin-top: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); color: var(--text);
        }
        .score-title { font-size: 12px; color: #bdc3c7; font-weight: 800; letter-spacing: 1px; }
        .score-val { font-family: 'Fredoka One', cursive; font-size: 45px; color: var(--gold); line-height: 1; margin-bottom: 10px; text-shadow: 2px 2px 0 #2c3e50; }

        /* BARRA DE PROGRESO DE META */
        .goal-container { width: 100%; margin-top: 5px; }
        .goal-bar-bg { width: 100%; height: 12px; background: #2c3e50; border-radius: 10px; overflow: hidden; border: 1px solid #1a252f; }
        .goal-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--green), #2ecc71); transition: width 0.3s; }
        .goal-text { font-size: 11px; color: #bdc3c7; margin-top: 4px; display: flex; justify-content: space-between; font-weight: bold; }

        /* ZONA DE JUEGO (NUEVO: CANVAS) */
        .game-wrapper {
            width: 100%;
            height: 350px; /* Altura del √°rea de juego */
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            border: 4px solid #34495e;
            /* Fondo de cielo y tierra */
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 20%, var(--ground-top) 20%, var(--ground-bottom) 100%);
            cursor: crosshair;
        }

        canvas { display: block; width: 100%; height: 100%; }
        
        /* EFECTOS FLOTANTES (Adaptados) */
        .float-plus { 
            position: absolute; font-weight: 900; font-size: 24px; 
            color: var(--gold); pointer-events: none; 
            animation: floatUp 1s forwards; 
            text-shadow: 2px 2px 0 #000; z-index: 20;
        }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-60px) scale(1.2); opacity: 0; } }

        /* BARRA DE ENERG√çA */
        .energy-container { width: 100%; background: #34495e; padding: 12px 15px; border-radius: 15px; border-bottom: 4px solid #2c3e50; text-align: center; color: var(--text); }
        .energy-track { width: 100%; height: 10px; background: #2c3e50; border-radius: 10px; overflow: hidden; margin: 5px 0; }
        .energy-fill { height: 100%; width: 100%; background: var(--energy); transition: width 0.2s; }
        .energy-text { font-size: 11px; font-weight: bold; color: #bdc3c7; display: flex; justify-content: space-between; }

        /* RECARGA OVERLAY */
        .refill-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95); z-index: 30; /* Mayor z-index para cubrir el canvas */
            display: none; flex-direction: column; justify-content: center; align-items: center;
            border-radius: 16px;
        }
        .btn-refill {
            background: var(--energy); color: white; padding: 12px 25px; border-radius: 50px;
            border: none; font-weight: 900; font-size: 16px; cursor: pointer;
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.4); animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* BONUS & FOOTER */
        .bonus-row { display: flex; gap: 8px; width: 100%; margin-top: 5px; }
        .btn-bonus {
            flex: 1; padding: 10px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; color: white; font-size: 11px;
            box-shadow: 0 3px 0 rgba(0,0,0,0.3); transition: transform 0.1s;
        }
        .btn-bonus:active { transform: translateY(3px); box-shadow: none; }
        .b-adsgram { background: #3742fa; }
        .b-monetag { background: #f39c12; }

        .btn-withdraw { 
            background: #34495e; color: #bdc3c7; width: 100%; padding: 15px; border: none; 
            border-radius: 12px; font-weight: 900; font-size: 16px; margin-top: 15px; 
            cursor: pointer; box-shadow: 0 4px 0 #2c3e50; transition: 0.3s;
        }
        .btn-withdraw.ready {
            background: linear-gradient(45deg, var(--green), #2ecc71); color: white;
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.6);
            animation: pulse 1.5s infinite; text-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }
        .btn-withdraw:active { transform: translateY(4px); box-shadow: none; }

        .mini-menu { display: flex; gap: 8px; width: 100%; margin-top: 10px; }
        .btn-mini {
            flex: 1; background: #34495e; border: 2px solid #2c3e50; color: #bdc3c7;
            padding: 8px; border-radius: 10px; font-size: 11px; font-weight: 800;
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px;
        }

        /* MODAL */
        #modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:100; }
        .modal-card { background: #ecf0f1; padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; color: #2c3e50; }
        .btn-green { background: var(--green); color: white; width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; box-shadow: 0 4px 0 #218c74; }
    </style>
</head>
<body>

    <div id="banScreen"><h2>Acceso Denegado</h2><p>Dispositivo vinculado.</p></div>

    <div class="app-container" id="appContent">
        
        <div class="score-board">
            <div class="score-title">ORO RECOLECTADO</div>
            <div class="score-val" id="score">0</div>
            <div class="goal-container">
                <div class="goal-bar-bg"><div class="goal-bar-fill" id="goalBar"></div></div>
                <div class="goal-text"><span>PROGRESO</span><span style="color:var(--green);">META: $0.10 USD</span></div>
            </div>
        </div>

        <div class="game-wrapper" id="gameWrapper">
            <canvas id="gameCanvas"></canvas>
            
            <div class="refill-overlay" id="refillOverlay">
                <div style="font-size:50px; margin-bottom:10px;">‚ö°</div>
                <h3 style="color:white; margin-bottom:5px;">SIN ENERG√çA</h3>
                <p style="color:#bdc3c7; margin-bottom:20px; font-size:14px;">Recarga para seguir minando.</p>
                <button class="btn-refill" onclick="refillEnergy()">
                    <i class="fa-solid fa-play"></i> VER VIDEO (+50‚ö°)
                </button>
            </div>
        </div>
        <p style="font-size: 10px; color: #bdc3c7; margin-top: -5px;">Toca la pantalla para lanzar el gancho</p>

        <div class="energy-container">
            <div class="energy-text"><span>ENERG√çA</span><span id="energyText">100/100</span></div>
            <div class="energy-track"><div class="energy-fill" id="energyBar"></div></div>
        </div>

        <div class="bonus-row">
            <button class="btn-bonus b-adsgram" onclick="watchEnergyBonus('adsgram')">
                <i class="fa-solid fa-bolt" style="margin-bottom:3px;"></i><span>+15 ENERG√çA</span>
            </button>
            <button class="btn-bonus b-monetag" onclick="watchEnergyBonus('monetag')">
                <i class="fa-solid fa-battery-full" style="margin-bottom:3px;"></i><span>+10 ENERG√çA</span>
            </button>
        </div>

        <button class="btn-withdraw" id="withdrawBtn" onclick="retirar()">
            <i class="fa-solid fa-lock"></i> META NO ALCANZADA
        </button>

        <div class="mini-menu">
            <button class="btn-mini" onclick="tg.openTelegramLink('https://t.me/AtencionYougamefavoriteBot')"><i class="fa-solid fa-headset"></i> Soporte</button>
            <button class="btn-mini" onclick="tg.openTelegramLink('https://t.me/noticebuddy')"><i class="fa-brands fa-telegram"></i> Canal</button>
        </div>
    </div>

    <div id="modal">
        <div class="modal-card">
            <h2 style="color:var(--green); margin-bottom:10px;">‚úÖ ¬°META ALCANZADA!</h2>
            <p style="color:#7f8c8d; font-size:13px; margin-bottom:15px;">Env√≠a esta captura para tu pago.</p>
            <div style="background:#bdc3c7; padding:15px; border-radius:10px; margin-bottom:15px; text-align:left; font-size:12px; color:#2c3e50; border: 2px dashed #7f8c8d;">
                <div><b>USUARIO:</b> <span id="recUser">...</span></div>
                <div><b>FECHA:</b> <span id="recDate">...</span></div>
                <div style="margin-top:5px; font-size:16px; color:#27ae60;"><b>TOTAL:</b> $0.10 USD</div>
            </div>
            <button class="btn-green" onclick="tg.openTelegramLink('https://t.me/AtencionYougamefavoriteBot')">üì© ENVIAR CAPTURA</button>
            <button style="background:none; border:none; color:#7f8c8d; margin-top:15px; cursor:pointer;" onclick="location.reload()">Cerrar Ventana</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        tg.setHeaderColor('#2c3e50'); tg.setBackgroundColor('#2c3e50');

        const ADSGRAM_ID = "18897"; 
        const KEY = 'goldminer_v1_prod'; // Nueva llave para el nuevo juego
        const META = 20000; 
        let user = { pts: 0, energy: 100 };

        // --- L√ìGICA DEL JUEGO DEL MINERO ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameWrapper = document.getElementById('gameWrapper');
        
        // Ajustar canvas al tama√±o del contenedor
        function resizeCanvas() {
            canvas.width = gameWrapper.clientWidth;
            canvas.height = gameWrapper.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Configuraci√≥n del juego
        let gameState = 'SWING'; // Estados: SWING (oscilando), FIRE (disparando), RETRACT (recogiendo)
        const hook = {
            x: canvas.width / 2, y: 60, // Punto de origen (donde est√° el minero)
            length: 40, minLength: 40, maxLength: canvas.height + 50,
            angle: Math.PI / 2, // Empieza mirando abajo
            swingSpeed: 0.03, swingDir: 1,
            fireSpeed: 10, retractSpeed: 10, baseRetractSpeed: 10,
            caughtItem: null
        };
        
        let items = []; // Array para guardar los objetos del suelo

        // Clase para los objetos (Oro, Piedra, Bomba)
        class Item {
            constructor(type, x, y) {
                this.type = type; this.x = x; this.y = y;
                this.caught = false;
                switch(type) {
                    case 'gold_big':   this.emoji = 'üí∞'; this.r = 30; this.val = 50; this.weight = 6; break;
                    case 'gold_small': this.emoji = 'üåï'; this.r = 15; this.val = 10; this.weight = 2; break;
                    case 'rock':       this.emoji = 'ü™®'; this.r = 22; this.val = 2;  this.weight = 8; break;
                    case 'bomb':       this.emoji = 'üí£'; this.r = 18; this.val = 0;  this.weight = 0; break;
                }
            }
            draw() {
                if(this.caught) return;
                ctx.font = `${this.r * 2}px Arial`; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.fillText(this.emoji, this.x, this.y);
            }
        }

        // Generar nivel
        function spawnItems() {
            items = [];
            const groundY = canvas.height * 0.25; // Donde empieza la tierra
            for(let i=0; i<12; i++) {
                let types = ['gold_big', 'gold_small', 'gold_small', 'rock', 'rock', 'bomb'];
                let type = types[Math.floor(Math.random()*types.length)];
                let x = 40 + Math.random() * (canvas.width - 80);
                let y = groundY + 40 + Math.random() * (canvas.height - groundY - 80);
                items.push(new Item(type, x, y));
            }
        }

        // Bucle principal del juego (Animaci√≥n)
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Limpiar canvas

            // Dibujar al minero
            ctx.font = "40px Arial"; ctx.textAlign = "center";
            ctx.fillText("üë∑‚Äç‚ôÇÔ∏è", canvas.width / 2, 40);

            // L√≥gica del gancho
            if(gameState === 'SWING') {
                hook.angle += hook.swingSpeed * hook.swingDir;
                if(hook.angle > Math.PI - 0.2 || hook.angle < 0.2) hook.swingDir *= -1;
                hook.length = hook.minLength;
            } 
            else if(gameState === 'FIRE') {
                hook.length += hook.fireSpeed;
                checkCollisions(); // Comprobar si toc√≥ algo
                // Si llega al l√≠mite, recoger
                if(hook.length >= hook.maxLength || hook.x + Math.cos(hook.angle)*hook.length < 0 || hook.x + Math.cos(hook.angle)*hook.length > canvas.width) {
                    gameState = 'RETRACT'; hook.retractSpeed = hook.baseRetractSpeed;
                }
            }
            else if(gameState === 'RETRACT') {
                hook.length -= hook.retractSpeed;
                if(hook.length <= hook.minLength) {
                    hook.length = hook.minLength;
                    gameState = 'SWING';
                    // Si tra√≠a algo, sumar puntos
                    if(hook.caughtItem) {
                        if(hook.caughtItem.val > 0) {
                            user.pts += hook.caughtItem.val;
                            save();
                            showFloatingText(`+${hook.caughtItem.val}`, hook.x, hook.y);
                            playSfx('success');
                        }
                        // Eliminar objeto capturado
                        items = items.filter(i => i !== hook.caughtItem);
                        hook.caughtItem = null;
                        // Si quedan pocos objetos, regenerar
                        if(items.length < 3) spawnItems();
                    }
                }
            }

            // Dibujar la l√≠nea del gancho
            let tipX = hook.x + Math.cos(hook.angle) * hook.length;
            let tipY = hook.y + Math.sin(hook.angle) * hook.length;
            ctx.beginPath(); ctx.moveTo(hook.x, hook.y); ctx.lineTo(tipX, tipY);
            ctx.strokeStyle = '#555'; ctx.lineWidth = 3; ctx.stroke();

            // Dibujar el ancla/gancho en la punta
            ctx.save(); ctx.translate(tipX, tipY); ctx.rotate(hook.angle - Math.PI/2);
            ctx.font = "30px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText("ü™ù", 0, 0); ctx.restore();

            // Dibujar objetos del suelo
            for(let item of items) item.draw();

            // Si el gancho trae algo, dibujarlo en la punta
            if(hook.caughtItem && gameState === 'RETRACT') {
                hook.caughtItem.x = tipX; hook.caughtItem.y = tipY + hook.caughtItem.r/2;
                hook.caughtItem.draw();
            }

            requestAnimationFrame(gameLoop);
        }

        // Detectar colisiones
        function checkCollisions() {
            let tipX = hook.x + Math.cos(hook.angle) * hook.length;
            let tipY = hook.y + Math.sin(hook.angle) * hook.length;

            for(let item of items) {
                if(item.caught) continue;
                let dx = tipX - item.x; let dy = tipY - item.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                if(dist < item.r + 10) { // Margen de colisi√≥n
                    if(item.type === 'bomb') {
                        // Bomba: Recoger r√°pido, sin puntos, peque√±a explosi√≥n visual
                        gameState = 'RETRACT'; hook.retractSpeed = hook.baseRetractSpeed * 2;
                        items = items.filter(i => i !== item); // Eliminar bomba
                        playSfx('tap'); // Sonido simple
                    } else {
                        // Agarrar objeto
                        gameState = 'RETRACT';
                        hook.caughtItem = item; item.caught = true;
                        // Velocidad depende del peso (m√°s peso = m√°s lento)
                        hook.retractSpeed = Math.max(2, hook.baseRetractSpeed - item.weight);
                    }
                    break; 
                }
            }
        }

        // Lanzar gancho al tocar el canvas
        gameWrapper.addEventListener('click', (e) => {
            // Evitar clic si es en el overlay de recarga o si ya est√° lanzando
            if(e.target.closest('.refill-overlay') || gameState !== 'SWING') return;
            
            if(user.energy > 0) {
                user.energy--;
                save();
                gameState = 'FIRE';
                playSfx('tap');
                tg.HapticFeedback.impactOccurred('light');
            } else {
                // Si no hay energ√≠a, el updateUI mostrar√° el overlay
                updateUI();
            }
        });

        function showFloatingText(text, x, y) {
            const el = document.createElement('div');
            el.className = 'float-plus';
            el.innerText = text;
            // Ajustar posici√≥n relativa al contenedor del juego
            let rect = gameWrapper.getBoundingClientRect();
            el.style.left = (x + rect.left) + 'px';
            el.style.top = (y + rect.top) + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        // --- FIN L√ìGICA DEL JUEGO ---

        // Efectos de sonido (Mantenido del original)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
       
