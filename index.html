<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Diamond Rush</title>
    
    <script src='//libtl.com/sdk.js' data-zone='10278425' data-sdk='show_10278425'></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg: #13151b;
            --card: #1e2129;
            --accent: #00e701; /* Verde Neon */
            --danger: #ff4757;
            --tile-closed: #2d3442;
            --text: #ffffff;
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Poppins', sans-serif; }
        
        body {
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 20px; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        }

        /* HEADER */
        .header { width: 100%; max-width: 400px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .balance-box { background: var(--card); padding: 8px 15px; border-radius: 12px; display: flex; align-items: center; gap: 8px; font-weight: bold; border: 1px solid #333; }
        .balance-val { font-size: 18px; color: var(--accent); }

        /* TABLERO DE JUEGO */
        .game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            width: 100%; max-width: 380px;
            margin-bottom: 20px;
        }
        
        .tile {
            aspect-ratio: 1;
            background: var(--tile-closed);
            border-radius: 12px;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            font-size: 28px;
            box-shadow: 0 4px 0 #1b2029;
            transition: transform 0.1s, background 0.2s;
            position: relative;
            overflow: hidden;
        }
        .tile:active { transform: translateY(4px); box-shadow: none; }
        .tile.revealed-gem { background: #2f3640; border: 2px solid var(--accent); animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .tile.revealed-bomb { background: var(--danger); animation: shake 0.4s; }
        
        @keyframes pop { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }

        /* CONTROLES */
        .controls { width: 100%; max-width: 380px; text-align: center; }
        
        .current-win-display {
            font-size: 14px; color: #aaa; margin-bottom: 5px;
            opacity: 0; transition: opacity 0.3s;
        }
        .current-win-val { font-size: 32px; font-weight: 900; color: white; text-shadow: 0 0 10px rgba(255,255,255,0.2); }

        .btn-main {
            width: 100%; padding: 18px; border: none; border-radius: 15px;
            font-size: 18px; font-weight: 900; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px;
            transition: 0.2s; margin-top: 10px;
            background: var(--accent); color: #000;
            box-shadow: 0 0 20px rgba(0, 231, 1, 0.3);
        }
        .btn-main:disabled { background: #333; color: #555; box-shadow: none; cursor: not-allowed; }
        
        .btn-cashout { background: #ff9f43; color: #000; display: none; box-shadow: 0 0 20px rgba(255, 159, 67, 0.4); }

        /* FOOTER DE ENERG√çA/ADS */
        .footer-actions { display: flex; gap: 10px; width: 100%; max-width: 380px; margin-top: 20px; }
        .btn-mini { flex: 1; background: var(--card); border: 1px solid #333; color: white; padding: 12px; border-radius: 10px; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer; }

        /* MODALES */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:none; justify-content:center; align-items:center; z-index: 100; backdrop-filter: blur(5px); }
        .modal-card { background: var(--card); padding: 30px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; border: 1px solid #333; }
        
        .bomb-icon { font-size: 60px; margin-bottom: 10px; display:block; }
        .win-icon { font-size: 60px; margin-bottom: 10px; display:block; }

        .btn-revive { background: #3742fa; color: white; width: 100%; padding: 15px; border:none; border-radius: 10px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        .btn-close { background: transparent; border: none; color: #777; margin-top: 15px; cursor: pointer; text-decoration: underline; }

        /* RETIRO */
        .btn-withdraw { width:100%; background: #2f3542; color: #aaa; padding:15px; border-radius:12px; border:none; margin-top:20px; font-weight:bold; }
        .btn-withdraw.ready { background: linear-gradient(45deg, #00e701, #00b894); color:black; animation: pulse 2s infinite; cursor: pointer; }
        
        .confetti { position: fixed; width: 10px; height: 10px; background-color: #f00; animation: fall linear forwards; z-index: 99; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

    </style>
</head>
<body>

    <div class="header">
        <div class="balance-box"><i class="fa-solid fa-coins" style="color:#f1c40f"></i> <span id="balance">0</span></div>
        <div class="balance-box" style="font-size:12px; background:#2c3e50;"><span id="energy">‚ö° 100%</span></div>
    </div>

    <div style="text-align:center; margin-bottom:15px;">
        <h2 style="margin:0; font-weight:900; font-style:italic;">DIAMOND RUSH</h2>
        <p style="margin:5px 0 0 0; font-size:12px; color:#777;">Encuentra diamantes, evita las bombas.</p>
    </div>

    <div class="game-board" id="board">
        </div>

    <div class="controls">
        <div class="current-win-display" id="winDisplay">
            GANANCIA ACTUAL<br>
            <div class="current-win-val">+<span id="currentWin">0</span></div>
        </div>

        <button class="btn-main" id="btnStart" onclick="startGame()">JUGAR (Costo: 50 Pts)</button>
        <button class="btn-main btn-cashout" id="btnCashout" onclick="cashout()">üí∞ RETIRAR GANANCIA</button>
    </div>

    <div class="footer-actions">
        <button class="btn-mini" onclick="watchAdForPoints()"><i class="fa-solid fa-play"></i> +500 Puntos Gratis</button>
        <button class="btn-mini" onclick="tg.openTelegramLink('https://t.me/noticebuddy')"><i class="fa-brands fa-telegram"></i> Canal</button>
    </div>

    <button class="btn-withdraw" id="withdrawBtn" onclick="tryWithdraw()">META: 50,000 Pts ($0.10)</button>

    <div class="modal-overlay" id="loseModal">
        <div class="modal-card">
            <span class="bomb-icon">üí•</span>
            <h2 style="color:var(--danger); margin:0;">¬°BOMBA!</h2>
            <p style="color:#ccc;">Has pisado una mina y perdiste tus ganancias acumuladas.</p>
            <button class="btn-revive" onclick="reviveWithAd()">
                <i class="fa-solid fa-video"></i> REVIVIR Y SEGUIR
            </button>
            <button class="btn-close" onclick="closeLoseModal()">Aceptar derrota</button>
        </div>
    </div>

    <div class="modal-overlay" id="winModal">
        <div class="modal-card" style="border-color:var(--accent);">
            <span class="win-icon">üíé</span>
            <h2 style="color:var(--accent); margin:0;">¬°EXCELENTE!</h2>
            <p style="color:#ccc;">Has retirado a tiempo.</p>
            <h1 style="font-size:40px; margin:10px 0;" id="finalWinAmount">+0</h1>
            <button class="btn-revive" style="background:var(--accent); color:black;" onclick="document.getElementById('winModal').style.display='none'">CONTINUAR</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        tg.setHeaderColor('#13151b'); tg.setBackgroundColor('#13151b');

        // --- CONFIGURACI√ìN ---
        const ADSGRAM_ID = "18897"; 
        const KEY = 'diamond_rush_v1';
        const BOARD_SIZE = 16; // 4x4
        const BOMB_COUNT = 4;  // 4 Bombas, 12 Diamantes
        const BET_COST = 50;   // Costo por partida
        const WITHDRAW_GOAL = 50000;

        // Estado del usuario
        let user = { points: 1000, energy: 100 }; // Empezamos con 1000 puntos de regalo
        
        // Estado de la partida actual
        let gameActive = false;
        let bombs = []; // Array de √≠ndices donde est√°n las bombas
        let revealedCount = 0;
        let currentMultiplier = 1.0;
        let currentWinnings = 0;
        let tempLostPoints = 0; // Para guardar puntos si quiere revivir

        // Multiplicadores progresivos (mientras m√°s abres, m√°s ganas)
        const multipliers = [1.2, 1.5, 2.0, 2.8, 4.0, 6.0, 9.0, 15.0, 25.0, 40.0, 60.0, 100.0];

        window.onload = function() {
            if(localStorage.getItem(KEY)) {
                try { user = JSON.parse(atob(localStorage.getItem(KEY))); } catch(e){}
            }
            createBoard();
            updateUI();
        };

        function save() {
            localStorage.setItem(KEY, btoa(JSON.stringify(user)));
            updateUI();
        }

        function updateUI() {
            document.getElementById('balance').innerText = user.points.toLocaleString();
            
            const wBtn = document.getElementById('withdrawBtn');
            if(user.points >= WITHDRAW_GOAL) {
                wBtn.classList.add('ready');
                wBtn.innerText = "¬°META ALCANZADA! RETIRAR $0.10";
            } else {
                wBtn.classList.remove('ready');
                wBtn.innerText = `META: ${WITHDRAW_GOAL.toLocaleString()} Pts ($0.10)`;
            }
        }

        function createBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            for(let i=0; i<BOARD_SIZE; i++) {
                let tile = document.createElement('div');
                tile.className = 'tile';
                tile.id = 'tile-'+i;
                tile.onclick = () => clickTile(i);
                tile.innerHTML = '<i class="fa-solid fa-question" style="font-size:14px; color:#444;"></i>';
                board.appendChild(tile);
            }
        }

        function startGame() {
            if(user.points < BET_COST) {
                tg.showAlert("¬°No tienes puntos suficientes! Mira un anuncio abajo para recargar.");
                return;
            }

            // Cobrar entrada
            user.points -= BET_COST;
            save();

            // Resetear juego
            gameActive = true;
            revealedCount = 0;
            currentMultiplier = 1.0;
            currentWinnings = BET_COST; 
            bombs = [];
            
            // Colocar bombas aleatorias
            while(bombs.length < BOMB_COUNT) {
                let r = Math.floor(Math.random() * BOARD_SIZE);
                if(bombs.indexOf(r) === -1) bombs.push(r);
            }

            // UI Reset
            document.querySelectorAll('.tile').forEach(t => {
                t.className = 'tile';
                t.innerHTML = '';
                t.style.background = 'var(--tile-closed)';
            });
            
            document.getElementById('btnStart').style.display = 'none';
            document.getElementById('btnCashout').style.display = 'block';
            document.getElementById('winDisplay').style.opacity = '1';
            updateWinningsDisplay();
        }

        function clickTile(index) {
            if(!gameActive) return;
            const tile = document.getElementById('tile-'+index);
            if(tile.classList.contains('revealed-gem')) return; // Ya clickeado

            if(bombs.includes(index)) {
                // üí• BOOM
                tile.classList.add('revealed-bomb');
                tile.innerHTML = 'üí£';
                handleGameOver(false);
            } else {
                // üíé GEM
                tile.classList.add('revealed-gem');
                tile.innerHTML = 'üíé';
                
                revealedCount++;
                // Calcular ganancia
                let mult = multipliers[revealedCount-1] || multipliers[multipliers.length-1];
                currentWinnings = Math.floor(BET_COST * mult);
                
                updateWinningsDisplay();
                tg.HapticFeedback.impactOccurred('medium');

                if(revealedCount === (BOARD_SIZE - BOMB_COUNT)) {
                    cashout(); // Gan√≥ todo el tablero
                }
            }
        }

        function updateWinningsDisplay() {
            document.getElementById('currentWin').innerText = currentWinnings.toLocaleString();
        }

        function cashout() {
            if(!gameActive) return;
            gameActive = false;
            
            user.points += currentWinnings;
            save();
            
            // Efecto visual
            document.getElementById('finalWinAmount').innerText = "+" + currentWinnings;
            document.getElementById('winModal').style.display = 'flex';
            fireConfetti();
            tg.HapticFeedback.notificationOccurred('success');

            resetControls();
        }

        function handleGameOver(revived) {
            gameActive = false;
            tempLostPoints = currentWinnings; // Guardar lo que iba a ganar
            
            // Mostrar todas las bombas
            bombs.forEach(b => {
                let t = document.getElementById('tile-'+b);
                t.classList.add('revealed-bomb');
                t.innerHTML = 'üí£';
            });

            setTimeout(() => {
                document.getElementById('loseModal').style.display = 'flex';
                tg.HapticFeedback.notificationOccurred('error');
            }, 500);
            
            resetControls();
        }

        function resetControls() {
            document.getElementById('btnStart').style.display = 'block';
            document.getElementById('btnCashout').style.display = 'none';
            document.getElementById('winDisplay').style.opacity = '0';
        }

        function closeLoseModal() {
            document.getElementById('loseModal').style.display = 'none';
            // Pierde oficialmente
        }

        // --- SISTEMA DE ADS ---

        function watchAdForPoints() {
            const AdController = window.Adsgram.init({ blockId: ADSGRAM_ID });
            AdController.show().then(() => {
                user.points += 500;
                save();
                tg.showPopup({title:"¬°Puntos Gratis!", message:"Has recibido 500 puntos."});
            }).catch(() => {
                 if (typeof show_10278425 === 'function') {
                    show_10278425().then(()=>{
                         user.points += 500; save(); tg.showPopup({title:"¬°Puntos Gratis!", message:"Recibidos 500 pts"});
                    });
                } else {
                    tg.showAlert("No hay anuncios disponibles ahora.");
                }
            });
        }

        function reviveWithAd() {
            // El usuario ve un video para recuperar sus puntos perdidos o seguir jugando
            const AdController = window.Adsgram.init({ blockId: ADSGRAM_ID });
            AdController.show().then(() => {
                // Recupera su apuesta inicial al menos
                user.points += BET_COST; 
                save();
                document.getElementById('loseModal').style.display = 'none';
                tg.showAlert("¬°Has recuperado el costo de tu apuesta! Int√©ntalo de nuevo.");
            }).catch((e) => {
                tg.showAlert("No pudimos cargar el anuncio de resurrecci√≥n.");
            });
        }

        function tryWithdraw() {
            if(user.points < WITHDRAW_GOAL) {
                tg.showAlert(`Necesitas ${WITHDRAW_GOAL.toLocaleString()} puntos. Sigue jugando.`);
                return;
            }
            user.points -= WITHDRAW_GOAL;
            save();
            tg.showPopup({
                title: 'SOLICITUD EXITOSA',
                message: 'Toma captura de pantalla y env√≠ala al bot para tu pago de $0.10.'
            });
        }

        function fireConfetti() {
            for(let i=0; i<30; i++) {
                let c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random()*100 + '%';
                c.style.background = ['#f00','#0f0','#00f','#ff0'][Math.floor(Math.random()*4)];
                c.style.animationDuration = (Math.random()*2+2)+'s';
                document.body.appendChild(c);
                setTimeout(()=>c.remove(), 4000);
            }
        }
    </script>
</body>
    </html>
