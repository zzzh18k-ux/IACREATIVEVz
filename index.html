<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>IA Studio Elite PRO</title>
    
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        :root {
            --ios-bg: #F2F2F7; 
            --ios-card: #FFFFFF;
            --ios-accent: #007AFF; 
            --ios-text: #1C1C1E;
            --ios-secondary: #8E8E93;
            --ios-green: #34C759;
        }

        body { 
            background-color: var(--ios-bg); 
            color: var(--ios-text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; padding: 20px; 
            display: flex; flex-direction: column; align-items: center;
        }

        .header {
            width: 100%; max-width: 400px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }

        .badge-credits {
            background: var(--ios-card);
            padding: 8px 18px; border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-weight: 700; color: var(--ios-accent);
        }

        .container {
            width: 100%; max-width: 400px;
            background: var(--ios-card);
            border-radius: 24px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.03);
            box-sizing: border-box;
            text-align: center;
        }

        textarea {
            width: 100%; border: none; background: #F9F9F9;
            border-radius: 16px; padding: 16px; font-size: 17px;
            margin-bottom: 20px; resize: none; outline: none; font-family: inherit;
            border: 1px solid transparent;
        }
        textarea:focus { border: 1px solid var(--ios-accent); }

        .btn {
            width: 100%; padding: 16px; border-radius: 14px;
            font-size: 17px; font-weight: 600; border: none;
            cursor: pointer; transition: all 0.2s ease;
            margin-bottom: 12px; display: flex; justify-content: center; align-items: center;
        }

        .btn-main { background-color: var(--ios-accent); color: white; }
        .btn-main:active { opacity: 0.8; transform: scale(0.98); }

        .btn-ads { background-color: #E5E5EA; color: var(--ios-accent); }

        .btn-download {
            background-color: var(--ios-green);
            color: white;
            display: none;
            margin-top: 15px;
        }

        /* BARRA DE PROGRESO */
        #progress-container { display: none; margin: 20px 0; }
        .progress-text { font-size: 13px; color: var(--ios-secondary); margin-bottom: 8px; font-weight: 500; }
        .progress-bar-bg { width: 100%; height: 6px; background: #E5E5EA; border-radius: 10px; overflow: hidden; }
        .progress-bar-fill { width: 0%; height: 100%; background: var(--ios-accent); transition: width 0.4s ease; }
        
        .result-wrapper {
            margin-top: 20px; width: 100%; border-radius: 20px;
            overflow: hidden; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #eee;
        }

        #resultado { width: 100%; display: block; background: #fff; }
    </style>
</head>
<body>

    <div class="header">
        <h1 style="font-size: 26px; font-weight: 700;">Studio Elite</h1>
        <div class="badge-credits">‚ö° <span id="val-creditos">3</span></div>
    </div>

    <div class="container">
        <textarea id="prompt" rows="3" placeholder="Escribe tu idea aqu√≠..."></textarea>
        
        <button class="btn btn-main" id="btn-gen" onclick="iniciarGeneracion()">Generar Imagen</button>
        <button class="btn btn-ads" onclick="accionAnuncio()">Obtener Energ√≠a</button>

        <div id="progress-container">
            <div class="progress-text" id="status-text">Conectando con el sat√©lite...</div>
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progress-fill"></div>
            </div>
        </div>

        <div class="result-wrapper" id="box-resultado">
            <img id="resultado">
        </div>

        <button class="btn btn-download" id="btn-descarga" onclick="descargarImagen()">
            ‚¨áÔ∏è Descargar en Galer√≠a
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor("#F2F2F7");

        let creditos = localStorage.getItem('user_creds_pro') ? parseInt(localStorage.getItem('user_creds_pro')) : 3;
        let intentos = 0;

        function refrescarUI() {
            document.getElementById('val-creditos').innerText = creditos;
            localStorage.setItem('user_creds_pro', creditos);
            document.getElementById('btn-gen').disabled = (creditos <= 0);
        }
        refrescarUI();

        async function accionAnuncio() {
            const AdController = window.Adsgram.init({ blockId: "18897" });
            AdController.show().then(() => {
                creditos += 2; refrescarUI();
                tg.showAlert("‚úÖ ¬°Energ√≠a cargada!");
            }).catch(() => {
                creditos += 1; refrescarUI();
                tg.showAlert("üéÅ +1‚ö° de cortes√≠a.");
            });
        }

        function iniciarGeneracion() {
            const p = document.getElementById('prompt').value;
            if(p.length < 2) return tg.showAlert("Escribe algo primero.");
            
            creditos -= 1; refrescarUI();
            intentos = 0; // Reiniciamos contador de intentos
            pedirImagen(p);
        }

        function pedirImagen(promptUser) {
            const progressCont = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            const statusText = document.getElementById('status-text');
            const box = document.getElementById('box-resultado');
            const btnD = document.getElementById('btn-descarga');
            const img = document.getElementById('resultado');

            progressCont.style.display = "block";
            box.style.display = "none";
            btnD.style.display = "none";
            progressFill.style.width = "20%";
            statusText.innerText = "Buscando servidor libre...";

            const seed = Math.floor(Math.random() * 1000000);
            const quality = "High-end photography, cinematic, 8k, masterpiece: ";
            const bypass = Date.now(); // C√ìDIGO √öNICO ANTI-BLOQUEO

            // LISTA DE MODELOS AGRESIVOS (Si uno falla, probamos el otro)
            const modelos = ["flux", "turbo", "unity"];
            const modeloActual = modelos[intentos % modelos.length];

            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(quality + promptUser)}?seed=${seed}&width=1024&height=1024&nologo=true&model=${modeloActual}&cachebust=${bypass}`;

            img.src = url;

            img.onload = () => {
                // Si la imagen carg√≥ pero es muy peque√±a (el aviso amarillo es peque√±o), reintentamos
                if (img.naturalWidth < 300 && intentos < 2) {
                    intentos++;
                    pedirImagen(promptUser);
                    return;
                }
                
                progressFill.style.width = "100%";
                statusText.innerText = "¬°Imagen lista!";
                
                setTimeout(() => {
                    progressCont.style.display = "none";
                    box.style.display = "block";
                    btnD.style.display = "flex";
                    tg.HapticFeedback.notificationOccurred('success');
                }, 500);
            };

            img.onerror = () => {
                if (intentos < 2) {
                    intentos++;
                    statusText.innerText = "Servidor ocupado, saltando a refuerzo...";
                    pedirImagen(promptUser);
                } else {
                    tg.showAlert("Todos los servidores est√°n llenos. Intenta en 1 minuto.");
                    progressCont.style.display = "none";
                }
            };
        }

        function descargarImagen() {
            const imgUrl = document.getElementById('resultado').src;
            tg.showPopup({
                title: 'Guardar Imagen',
                message: 'Para descargar, abre la imagen y mantenla presionada.',
                buttons: [{id: 'ok', type: 'default', text: 'Abrir Imagen'}]
            }, (id) => {
                if(id === 'ok') tg.openLink(imgUrl);
            });
        }
    </script>
</body>
                    </html>
